# FDF 语法树解析器技术文档

## 概述

本项目实现了完整的 WC3 原生 FDF (Frame Definition File) 格式解析器，支持从 FDF 文本到内部 FrameData 格式的双向转换。

## 架构设计

解析器采用经典的**词法分析 → 语法分析 → 语义转换**三层架构：

```
FDF 文本
    ↓
[词法分析器 (Lexer)] → Token 流
    ↓
[语法分析器 (Parser)] → AST (抽象语法树)
    ↓
[转换器 (Transformer)] → FrameData
```

导出器则按相反方向：

```
FrameData
    ↓
[导出器 (Exporter)] → FDF 文本
```

## 核心模块

### 1. fdfAst.ts - AST 类型定义

定义了 FDF 语法树的所有节点类型：

- **FDFProgram**: 顶层节点，包含所有 Frame 定义
- **FDFFrameDefinition**: Frame 定义节点
- **FDFNestedFrame**: 嵌套元素（Texture, String 等）
- **FDFProperty**: 属性节点
- **FDFPropertyValue**: 属性值（字符串、数字、标识符、数组）

支持的 Frame 类型：
```
FRAME, BACKDROP, TEXT, BUTTON, GLUETEXTBUTTON, GLUEBUTTON, 
HIGHLIGHT, SPRITE, MODEL, SLIDER, SIMPLEFRAME, SIMPLEBUTTON, 
SIMPLEFONTSTRING, SIMPLESTATUSBAR, EDITBOX, SCROLLBAR, LISTBOX, 
MENU, POPUPMENU, CHECKBOX, DIALOG, CONTROL
```

### 2. fdfLexer.ts - 词法分析器

将 FDF 文本转换为 Token 流。

**Token 类型**:
- `STRING`: 字符串字面量 (引号包围)
- `NUMBER`: 数字字面量 (整数、浮点数、科学计数法)
- `IDENTIFIER`: 标识符 (属性名、枚举值等)
- `FRAME`: 关键字 Frame
- `INHERITS`: 关键字 INHERITS
- `INCLUDE_FILE`: 关键字 IncludeFile
- `LEFT_BRACE`: `{`
- `RIGHT_BRACE`: `}`
- `COMMA`: `,`
- `COMMENT`: 注释 (`//` 或 `/* */`)

**特性**:
- 支持单行 `//` 和多行 `/* */` 注释
- 支持字符串转义序列 (`\n`, `\t`, `\"`, `\\`)
- 支持科学计数法 (`1.23e-4`)
- 自动跳过空白字符

### 3. fdfParser.ts - 语法分析器

将 Token 流转换为 AST。

**解析规则**:

```
Program ::= (Include | FrameDefinition | Comment)*

Include ::= 'IncludeFile' STRING

FrameDefinition ::= 'Frame' STRING STRING ['INHERITS' STRING] '{' Property* '}'

Property ::= IDENTIFIER [PropertyValue (',' PropertyValue)*]
           | NestedFrame

NestedFrame ::= IDENTIFIER [STRING] ['INHERITS' STRING] '{' Property* '}'

PropertyValue ::= STRING | NUMBER | IDENTIFIER
```

**示例 FDF**:
```fdf
Frame "BACKDROP" "MyBackdrop" INHERITS "ParentTemplate" {
  Width 0.256
  Height 0.032
  SetPoint TOPLEFT, "UIParent", TOPLEFT, 0.0, 0.0
  
  Texture {
    File "EscMenuBackground"
    TexCoord 0.0, 1.0, 0.0, 1.0
  }
}
```

### 4. fdfTransformer.ts - AST 转换器

将 AST 转换为内部 FrameData 格式。

**转换规则**:

| FDF 属性 | FrameData 属性 | 说明 |
|---------|---------------|------|
| Width | width | 转换为像素值 |
| Height | height | 转换为像素值 |
| SetPoint / Anchor | anchors | 锚点数组 |
| SetAllPoints | anchors + width + height | 填充父窗口 |
| Text | text | 文本内容 |
| FontColor | textColor | RGBA → Hex 颜色 |
| FontJustificationH | horAlign | 水平对齐 |
| FontJustificationV | verAlign | 垂直对齐 |
| File / BackdropBackground | diskTexture, wc3Texture | 纹理路径 |

**坐标转换**:
- FDF 使用相对坐标（0-1 范围）
- FrameData 使用绝对像素坐标
- 转换公式: `pixels = relative * baseWidth/Height`

**Frame 类型映射**:

| FDF 类型 | FrameType 枚举 |
|---------|---------------|
| BACKDROP, SIMPLEFRAME | BACKDROP (1) |
| TEXT, SIMPLEFONTSTRING | TEXT_FRAME (13) |
| BUTTON, GLUETEXTBUTTON | BUTTON (2) |
| EDITBOX | EDITBOX (19) |
| CHECKBOX | CHECKBOX (11) |
| SLIDER | SLIDER (20) |

### 5. fdfExporter.ts - FDF 导出器

将 FrameData 转换为 FDF 文本。

**导出选项**:
```typescript
{
  indent: '\t',           // 缩进字符串
  includeComments: true,  // 是否包含注释
  baseWidth: 800,         // 画布宽度
  baseHeight: 600         // 画布高度
}
```

**导出格式**:
```fdf
// Generated by WC3 UI Designer
// 2024-01-15T12:00:00.000Z

Frame "BACKDROP" "MyFrame" {
	Width 0.320000
	Height 0.053333
	Anchor TOPLEFT, 0.125000, 0.166667
	Text "Hello World"
	FontColor 1.000000 1.000000 1.000000 1.000000
	FontJustificationH JUSTIFYCENTER
	Texture {
		File "UI\\Widgets\\EscMenu\\Human\\editbox-background.blp"
	}
}
```

### 6. fdf.ts - 统一入口

提供高级 API：

```typescript
// 解析 FDF 文本
const frames = parseFDF(fdfText, {
  baseWidth: 800,
  baseHeight: 600,
  resolveInheritance: true
});

// 导出为 FDF
const fdfText = exportFDF(frames, {
  indent: '\t',
  includeComments: true
});

// 验证 FDF 格式
const validation = validateFDF(fdfText);
if (!validation.valid) {
  console.error('错误:', validation.errors);
}

// 格式化 FDF
const formatted = formatFDF(fdfText, {
  indent: '  '
});
```

## 支持的 FDF 特性

### ✅ 已支持

- [x] Frame 定义
- [x] INHERITS 模板继承（解析但暂不自动展开）
- [x] IncludeFile 文件包含指令
- [x] 嵌套元素（Texture, String）
- [x] 单行和多行注释
- [x] 属性赋值（单值、多值、字符串）
- [x] 锚点定位（Anchor, SetPoint）
- [x] 文本属性（Text, FontColor, FontJustification）
- [x] 纹理属性（File, TexCoord, AlphaMode）
- [x] 标志位属性（DecorateFileNames, SetAllPoints）

### 🚧 部分支持

- [ ] 模板自动展开（需要模板注册表）
- [ ] IncludeFile 自动加载（需要文件系统访问）
- [ ] TexCoord 纹理坐标映射
- [ ] AlphaMode 混合模式

### ❌ 未支持

- [ ] 动画定义
- [ ] 事件处理器（OnClick, OnMouseEnter 等）
- [ ] 复杂表达式计算

## 使用示例

### 示例 1: 导入 WC3 原生 FDF

```typescript
import { parseFDF } from './utils/fdf';

// 读取原生 FDF 文件
const fdfContent = await fs.readFile('target/vendor/UI/FrameDef/UI/ConsoleUI.fdf', 'utf-8');

// 解析为 FrameData
const frames = parseFDF(fdfContent, {
  baseWidth: 800,
  baseHeight: 600
});

// 添加到项目
frames.forEach(frame => {
  projectStore.addFrame(frame);
});
```

### 示例 2: 导出为 FDF

```typescript
import { exportFDF } from './utils/fdf';

// 获取当前项目的所有 Frame
const frames = Object.values(projectStore.frames);

// 导出为 FDF
const fdfText = exportFDF(frames, {
  indent: '\t',
  includeComments: true,
  baseWidth: 800,
  baseHeight: 600
});

// 保存到文件
await fs.writeFile('output.fdf', fdfText, 'utf-8');
```

### 示例 3: 验证和格式化

```typescript
import { validateFDF, formatFDF } from './utils/fdf';

// 验证
const validation = validateFDF(userInputFDF);
if (!validation.valid) {
  alert('FDF 格式错误: ' + validation.errors.join('\n'));
  return;
}

// 格式化
const formattedFDF = formatFDF(userInputFDF, {
  indent: '  ',  // 使用 2 空格缩进
  includeComments: true
});
```

## 性能优化

- **词法分析**: 单次遍历，时间复杂度 O(n)
- **语法分析**: 递归下降解析，平均 O(n)
- **内存占用**: AST 节点按需创建，支持流式处理（待实现）

## 错误处理

所有模块都提供详细的错误信息：

```typescript
try {
  const frames = parseFDF(fdfText);
} catch (error) {
  // 错误包含行号和列号
  console.error(error);
  // 示例: "Expected token type STRING but got NUMBER at line 15:23"
}
```

## 扩展性

### 添加新属性支持

1. 在 `fdfAst.ts` 的 `FDF_PROPERTIES` 中添加属性定义
2. 在 `fdfTransformer.ts` 的 `applyProperty` 中添加转换逻辑
3. 在 `fdfExporter.ts` 的 `exportFrame` 中添加导出逻辑

### 添加新 Frame 类型

1. 在 `fdfAst.ts` 的 `FDF_FRAME_TYPES` 中添加类型名
2. 在 `fdfTransformer.ts` 的 `mapFrameType` 中添加映射
3. 在 `fdfExporter.ts` 的 `mapFrameType` 中添加反向映射

## 测试

运行测试：

```typescript
import { testFDFParser } from './utils/fdfTest';

testFDFParser();
```

测试覆盖：
- 词法分析（注释、字符串、数字、标识符）
- 语法分析（Frame 定义、嵌套元素、属性）
- AST 转换（坐标转换、类型映射、颜色转换）
- FDF 导出（格式化、转义、缩进）

## 已知限制

1. **模板继承**: 仅解析 INHERITS 关键字，不自动展开模板内容
2. **文件包含**: 仅解析 IncludeFile 指令，不自动加载文件
3. **相对定位**: 锚点支持解析，但实际渲染需要布局引擎
4. **纹理坐标**: 解析但不转换（WC3 使用不同的纹理系统）

## 未来改进

- [ ] 实现模板注册表和自动展开
- [ ] 支持 IncludeFile 自动加载和递归解析
- [ ] 支持 FDF 宏和变量替换
- [ ] 优化大文件解析性能（流式处理）
- [ ] 支持增量解析和热重载
- [ ] 生成 TypeScript 类型定义

## 参考资料

- WC3 原生 FDF 文件: `target/vendor/UI/FrameDef/UI/`
- 关键文件:
  - `EscMenuTemplates.fdf` - 模板系统示例
  - `ConsoleUI.fdf` - 纹理和锚点示例
  - `ResourceBar.fdf` - 字体和文本示例
  - `InfoPanelUnitDetail.fdf` - 复杂嵌套示例

## 版本历史

- **v1.0** (2024-01-15): 初始版本
  - 完整的词法分析、语法分析、AST 转换
  - 支持基础 Frame 定义、属性、嵌套元素
  - 双向转换（FDF ↔ FrameData）
